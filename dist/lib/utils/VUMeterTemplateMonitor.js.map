{"version":3,"file":"VUMeterTemplateMonitor.js","sourceRoot":"","sources":["../../../src/lib/utils/VUMeterTemplateMonitor.ts"],"names":[],"mappings":"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","sourcesContent":["import path from 'path';\nimport np from '../NowPlayingContext';\nimport FSMonitor from './FSMonitor';\nimport { VUMeter } from 'now-playing-common';\nimport VUMeterConfigParser from './VUMeterConfigParser';\nimport { rnd } from './Misc';\nimport { listDirectories } from './System';\n\nexport const VU_METER_TEMPLATE_PATH = '/data/INTERNAL/NowPlayingPlugin/VU Meter Templates';\n\nclass VUMeterTemplateMonitor extends FSMonitor<['addDir', 'unlinkDir']> {\n\n  name = 'VUMeterTemplateMonitor';\n\n  #templates: Array<{name: string; meters: VUMeter[]}>;\n  #isSorted: boolean;\n\n  constructor() {\n    super(VU_METER_TEMPLATE_PATH, [ 'addDir', 'unlinkDir' ]);\n    this.#templates = [];\n    this.#isSorted = false;\n  }\n\n  getTemplates() {\n    if (this.status === 'stopped') {\n      np.getLogger().warn('[now-playing] VUMeterTemplateMonitor is not running. Returning empty image list.');\n      return [];\n    }\n    if (!this.#isSorted) {\n      this.#sortTemplates();\n    }\n    return this.#templates;\n  }\n\n  async getRandomTemplate() {\n    if (this.status === 'initializing') {\n      np.getLogger().info('[now-playing] Getting random template directly from template path');\n      const directories = await listDirectories(VU_METER_TEMPLATE_PATH);\n      if (directories.length === 0) {\n        return null;\n      }\n      return directories[rnd(0, directories.length - 1)];\n    }\n\n    if (this.#templates.length > 0) {\n      np.getLogger().info('[now-playing] Getting random template from loaded templates');\n      return this.#templates[rnd(0, this.#templates.length - 1)].name;\n    }\n\n    return null;\n  }\n\n  async stop() {\n    super.stop();\n    this.#templates = [];\n    this.#isSorted = false;\n  }\n\n  protected handleEvent(event: 'addDir' | 'unlinkDir', _path: string): void {\n    const { base: template } = path.parse(_path);\n\n    np.getLogger().info(`[now-playing] VUMeterTemplateMonitor captured '${event}': ${template}`);\n\n    switch (event) {\n      case 'addDir':\n        const config = VUMeterConfigParser.getConfig(template);\n        if (config.meters) {\n          this.#templates.push({\n            name: template,\n            meters: config.meters\n          });\n        }\n        this.#isSorted = false;\n        break;\n      case 'unlinkDir':\n        const index = this.#templates.findIndex((t) => t.name === template);\n        if (index >= 0) {\n          this.#templates.splice(index, 1);\n        }\n        break;\n      default:\n    }\n  }\n\n  #sortTemplates() {\n    this.#templates.sort((t1, t2) => t1.name.localeCompare(t2.name));\n    this.#isSorted = true;\n  }\n}\n\nconst vuMeterTemplateMonitor = new VUMeterTemplateMonitor();\n\nexport default vuMeterTemplateMonitor;\n"]}